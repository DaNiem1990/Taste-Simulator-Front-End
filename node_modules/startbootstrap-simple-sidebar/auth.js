Vue.component('user-details', {
    props: ['objects'],
    template:`
        <ul v-if="objects">
            <li>Id: {{objects.id}}</li>
            <li>Name: {{objects.name}}</li>
            <li>Email: {{objects.email}}</li>
        </ul>
    `
});

tasteSimulator = new Vue({
    el: 'div.maincontainer',
    data: {
        'greeting': {
            'notlogged': 'Zaloguj się',
            'logged': 'Witaj w Taste Simulator',
            'register': 'Zarejestruj się'
        },
        'email': '',
        'name': '',
        'password': '',
        'c_password': '',
        'loading': false,
        'apiToken': '',
        'logged': false,
        'error': '',
        'userDetails': {},
    },
    methods: {
        login: function () {
            if (this.email.length<3) {
                alert('Podaj email')
            } else {
                if (this.password<6) {
                    alert('Podaj hasło (minimum 8 znaków)')
                } else {
                    this.loading = true
                    this.error = ''
                    axios.post(
                        'http://tsa.zobacztu.pl/api/login', {
                            'email': this.email,
                            'password': this.password
                        }
                    )
                        .then(response => {
                            this.apiToken = response.data.token
                        })
                        .catch(error => {
                            this.error = 'Błąd logowania<br>Sprawdź email lub hasło'
                        })
                        .finally(()=>{
                            this.loading = false
                            if (this.apiToken.length>2) {
                                this.logged = true
                                this.showUserDetails()
                            }
                        })
                }
            }
        },
        register: function () {
            if (this.email.length<3) {
                alert('Podaj email')
            }  else {
                if (this.name<4) {
                    alert('Podaj imię (minimum 4 znaki)')
                }else {
                    if (this.password<6) {
                        alert('Podaj hasło (minimum 8 znaków)')

                    } if (this.c_password !== this.password) {
                        alert('Podane hasła nie są identyczne')
                    }else {
                        this.loading = true
                        this.error = ''
                        axios.post(
                            'http://tsa.zobacztu.pl/api/register', {
                                'email': this.email,
                                'name': this.name,
                                'password': this.password
                            }
                        )
                            .then(response => {this.apiToken = response.data.token})
                            .catch(error => {this.error = 'Błąd rejestracji<br>Sprawdź email lub hasło'})
                            .finally(()=>{
                                this.loading = false
                                if (this.apiToken.length>2) {
                                    this.logged = true
                                    this.showUserDetails()
                                }
                            })
                    }
                }
            }
        },
        showUserDetails: function () {
            this.loading = true
            this.error = ''
            const options = { headers: {
                    "Access-Control-Allow-Origin" : "*",
                    "Content-type": "Application/json",
                    "Authorization": "Bearer "+this.apiToken
                }}
            axios.get(
                'http://tsa.zobacztu.pl/api/get-user', options
            )
                .then(response => {
                    this.userDetails = response.data.user
                })
                .catch(error =>{
                    this.error = 'Błąd pobierania danych o użytkowniku'
                })
                .finally(()=>{
                    this.loading = false
                })
        },
    }
})